<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1, minimum-scale=1" />
<meta name="generator" content="pdoc 0.10.0" />
<title>p2k2_converter.core API documentation</title>
<meta name="description" content="" />
<link rel="preload stylesheet" as="style" href="https://cdnjs.cloudflare.com/ajax/libs/10up-sanitize.css/11.0.1/sanitize.min.css" integrity="sha256-PK9q560IAAa6WVRRh76LtCaI8pjTJ2z11v0miyNNjrs=" crossorigin>
<link rel="preload stylesheet" as="style" href="https://cdnjs.cloudflare.com/ajax/libs/10up-sanitize.css/11.0.1/typography.min.css" integrity="sha256-7l/o7C8jubJiy74VsKTidCy1yBkRtiUGbVkYBylBqUg=" crossorigin>
<link rel="stylesheet preload" as="style" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/10.1.1/styles/github.min.css" crossorigin>
<style>:root{--highlight-color:#fe9}.flex{display:flex !important}body{line-height:1.5em}#content{padding:20px}#sidebar{padding:30px;overflow:hidden}#sidebar > *:last-child{margin-bottom:2cm}.http-server-breadcrumbs{font-size:130%;margin:0 0 15px 0}#footer{font-size:.75em;padding:5px 30px;border-top:1px solid #ddd;text-align:right}#footer p{margin:0 0 0 1em;display:inline-block}#footer p:last-child{margin-right:30px}h1,h2,h3,h4,h5{font-weight:300}h1{font-size:2.5em;line-height:1.1em}h2{font-size:1.75em;margin:1em 0 .50em 0}h3{font-size:1.4em;margin:25px 0 10px 0}h4{margin:0;font-size:105%}h1:target,h2:target,h3:target,h4:target,h5:target,h6:target{background:var(--highlight-color);padding:.2em 0}a{color:#058;text-decoration:none;transition:color .3s ease-in-out}a:hover{color:#e82}.title code{font-weight:bold}h2[id^="header-"]{margin-top:2em}.ident{color:#900}pre code{background:#f8f8f8;font-size:.8em;line-height:1.4em}code{background:#f2f2f1;padding:1px 4px;overflow-wrap:break-word}h1 code{background:transparent}pre{background:#f8f8f8;border:0;border-top:1px solid #ccc;border-bottom:1px solid #ccc;margin:1em 0;padding:1ex}#http-server-module-list{display:flex;flex-flow:column}#http-server-module-list div{display:flex}#http-server-module-list dt{min-width:10%}#http-server-module-list p{margin-top:0}.toc ul,#index{list-style-type:none;margin:0;padding:0}#index code{background:transparent}#index h3{border-bottom:1px solid #ddd}#index ul{padding:0}#index h4{margin-top:.6em;font-weight:bold}@media (min-width:200ex){#index .two-column{column-count:2}}@media (min-width:300ex){#index .two-column{column-count:3}}dl{margin-bottom:2em}dl dl:last-child{margin-bottom:4em}dd{margin:0 0 1em 3em}#header-classes + dl > dd{margin-bottom:3em}dd dd{margin-left:2em}dd p{margin:10px 0}.name{background:#eee;font-weight:bold;font-size:.85em;padding:5px 10px;display:inline-block;min-width:40%}.name:hover{background:#e0e0e0}dt:target .name{background:var(--highlight-color)}.name > span:first-child{white-space:nowrap}.name.class > span:nth-child(2){margin-left:.4em}.inherited{color:#999;border-left:5px solid #eee;padding-left:1em}.inheritance em{font-style:normal;font-weight:bold}.desc h2{font-weight:400;font-size:1.25em}.desc h3{font-size:1em}.desc dt code{background:inherit}.source summary,.git-link-div{color:#666;text-align:right;font-weight:400;font-size:.8em;text-transform:uppercase}.source summary > *{white-space:nowrap;cursor:pointer}.git-link{color:inherit;margin-left:1em}.source pre{max-height:500px;overflow:auto;margin:0}.source pre code{font-size:12px;overflow:visible}.hlist{list-style:none}.hlist li{display:inline}.hlist li:after{content:',\2002'}.hlist li:last-child:after{content:none}.hlist .hlist{display:inline;padding-left:1em}img{max-width:100%}td{padding:0 .5em}.admonition{padding:.1em .5em;margin-bottom:1em}.admonition-title{font-weight:bold}.admonition.note,.admonition.info,.admonition.important{background:#aef}.admonition.todo,.admonition.versionadded,.admonition.tip,.admonition.hint{background:#dfd}.admonition.warning,.admonition.versionchanged,.admonition.deprecated{background:#fd4}.admonition.error,.admonition.danger,.admonition.caution{background:lightpink}</style>
<style media="screen and (min-width: 700px)">@media screen and (min-width:700px){#sidebar{width:30%;height:100vh;overflow:auto;position:sticky;top:0}#content{width:70%;max-width:100ch;padding:3em 4em;border-left:1px solid #ddd}pre code{font-size:1em}.item .name{font-size:1em}main{display:flex;flex-direction:row-reverse;justify-content:flex-end}.toc ul ul,#index ul{padding-left:1.5em}.toc > ul > li{margin-top:.5em}}</style>
<style media="print">@media print{#sidebar h1{page-break-before:always}.source{display:none}}@media print{*{background:transparent !important;color:#000 !important;box-shadow:none !important;text-shadow:none !important}a[href]:after{content:" (" attr(href) ")";font-size:90%}a[href][title]:after{content:none}abbr[title]:after{content:" (" attr(title) ")"}.ir a:after,a[href^="javascript:"]:after,a[href^="#"]:after{content:""}pre,blockquote{border:1px solid #999;page-break-inside:avoid}thead{display:table-header-group}tr,img{page-break-inside:avoid}img{max-width:100% !important}@page{margin:0.5cm}p,h2,h3{orphans:3;widows:3}h1,h2,h3,h4,h5,h6{page-break-after:avoid}}</style>
<script defer src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/10.1.1/highlight.min.js" integrity="sha256-Uv3H6lx7dJmRfRvH8TH6kJD1TSK1aFcwgx+mdg3epi8=" crossorigin></script>
<script>window.addEventListener('DOMContentLoaded', () => hljs.initHighlighting())</script>
</head>
<body>
<main>
<article id="content">
<header>
<h1 class="title">Module <code>p2k2_converter.core</code></h1>
</header>
<section id="section-intro">
<details class="source">
<summary>
<span>Expand source code</span>
</summary>
<pre><code class="python">from p2k2_converter.core.parser import Parser

__all__ = [&#34;Parser&#34;]</code></pre>
</details>
</section>
<section>
<h2 class="section-title" id="header-submodules">Sub-modules</h2>
<dl>
<dt><code class="name"><a title="p2k2_converter.core.classes" href="classes/index.html">p2k2_converter.core.classes</a></code></dt>
<dd>
<div class="desc"></div>
</dd>
<dt><code class="name"><a title="p2k2_converter.core.parser" href="parser.html">p2k2_converter.core.parser</a></code></dt>
<dd>
<div class="desc"></div>
</dd>
<dt><code class="name"><a title="p2k2_converter.core.utils" href="utils/index.html">p2k2_converter.core.utils</a></code></dt>
<dd>
<div class="desc"></div>
</dd>
<dt><code class="name"><a title="p2k2_converter.core.workflow" href="workflow/index.html">p2k2_converter.core.workflow</a></code></dt>
<dd>
<div class="desc"></div>
</dd>
</dl>
</section>
<section>
</section>
<section>
</section>
<section>
<h2 class="section-title" id="header-classes">Classes</h2>
<dl>
<dt id="p2k2_converter.core.Parser"><code class="flex name class">
<span>class <span class="ident">Parser</span></span>
<span>(</span><span>workbook_path: pathlib.Path, config_file: str)</span>
</code></dt>
<dd>
<div class="desc"></div>
<details class="source">
<summary>
<span>Expand source code</span>
</summary>
<pre><code class="python">class Parser:
    def __init__(self, workbook_path: Path, config_file: str):
        self.__workbook_path = workbook_path
        try:
            self.__workbook = load_workbook(workbook_path, data_only=True)
        except FileNotFoundError:
            logging.error(f&#34;Error: File {workbook_path} not found.&#34;)
            raise
        except Exception as e:
            logging.error(f&#34;Error: {e}&#34;)
            raise

        from p2k2_converter.pipeline import Pipeline
        self.__workflow_pipeline = Pipeline(source=XlsmSource(str(self.__workbook_path)))
        with open(config_file, &#34;r&#34;) as file:
            self.__config_file = yaml.safe_load(file)

    def __create_workflow_for(self, product: str, row_number: int) -&gt; Branch:
        &#34;&#34;&#34;
        Create a workflow branch for the given product.
        Args:
            product: The string containing the name of the product
            row_number: The number of the row inside the excell file

        Returns:
            Return a branch containing a preconfigured workflow for the product in input.

        &#34;&#34;&#34;
        from p2k2_converter.pipeline.branch import BranchBuilder
        args = (row_number, self.__config_file)
        strategy = workflow_for_product(product, *args)
        builder = BranchBuilder(f&#34;{product}_WORKFLOW_{row_number}&#34;)

        builder.add_from_function(strategy.model_definition) \
            .add_from_function(strategy.profiles_definition) \
            .add_from_function(strategy.cuts_definition) \
            .add_from_function(strategy.machining_definition) \
            .add_from_function(strategy.translation_definition)

        return builder.build()

    def __define_workflows(self, cell_values: List) -&gt; None:
        &#34;&#34;&#34;
        Populate the workflow pipeline with the products found in the excell file. The workflow for each product should
        be described inside the configuration file.
        Args:
            cell_values: A list containing the name of the products that should be produced. This should be extracted
                         from the excell file in input.
        &#34;&#34;&#34;
        product_counter = Counter(cell_values)
        for product, occurrences in product_counter.items():

            if product not in self.__config_file:
                logging.warning(f&#34;Product {product} not found in the configuration file.&#34;)
                continue

            config = self.__config_file[product]
            target_worksheet = self.__workbook[config[&#34;worksheet&#34;]]
            remaining_occurrences = occurrences

            configuration_range = f&#34;{config[&#39;product-column&#39;]}{config[&#39;starting-row&#39;]}:&#34; \
                                  f&#34;{config[&#39;pieces-column&#39;]}{config[&#39;ending-row&#39;]}&#34;

            for row in target_worksheet[configuration_range]:
                if remaining_occurrences == 0:
                    break
                name = row[0].value
                pieces = row[1].value

                if name == product:
                    logging.info(f&#34;Creating workflow for {name} with {pieces} pieces.&#34;)
                    for _ in range(pieces):
                        self.__workflow_pipeline.add_branch(self.__create_workflow_for(name, row[0].row))
                        remaining_occurrences -= 1

    def __get_buyer_information(self) -&gt; Buyer:
        &#34;&#34;&#34;
        Retrieve the Buyer&#39;s information from the input excell file.

        Returns:
            An instance of  Buyer class containing the information of the buyer of the order
        &#34;&#34;&#34;
        global_config = self.__config_file[&#34;GLOBALS&#34;]
        buyer_config = global_config[&#34;buyer&#34;]
        worksheet = self.__workbook[global_config[&#34;input-worksheet&#34;]]

        info_column = buyer_config[&#39;column&#39;]

        full_name = worksheet[f&#34;{info_column}{buyer_config[&#39;full-name-row&#39;]}&#34;].value
        email = worksheet[f&#34;{info_column}{buyer_config[&#39;email-row&#39;]}&#34;].value
        phone = worksheet[f&#34;{info_column}{buyer_config[&#39;telephone-row&#39;]}&#34;].value
        cell_phone = worksheet[f&#34;{info_column}{buyer_config[&#39;cellphone-row&#39;]}&#34;].value
        address = worksheet[f&#34;{info_column}{buyer_config[&#39;address-row&#39;]}&#34;].value
        city = worksheet[f&#34;{info_column}{buyer_config[&#39;city-row&#39;]}&#34;].value

        return Buyer(full_name=full_name, email=email, phone=phone, cell_phone=cell_phone, address=address, city=city)

    def __calculate_bars_for_order(self, order: Order) -&gt; Dict[str, Dict[str, Tuple[Tuple[int, int], ...]]]:
        &#34;&#34;&#34;
        Calculate the number of bars needed for the order in input.
        The function will read the values from the table in the &#34;available-bar-worksheet&#34; worksheet inside the excell
        file and will calculate the number of bars needed for each model depending on the total length of the pieces to
        produce.
        Args:
            order: The order to be produced.

        Returns:
            A dictionary where each key is a profile code and each value is a tuple of tuples in which each one contains
            the length of the bar and the number of bars needed.
        &#34;&#34;&#34;

        model_profile_cuts = {}
        for model in order.models:
            profile_cuts = {}
            for profile_code, profile in model.profiles.items():
                if profile_code not in profile_cuts:
                    profile_cuts[profile_code] = []
                profile_cuts[profile_code] += [cut.length for cut in profile.cuts]
            model_profile_cuts[model.name] = profile_cuts

        global_config = self.__config_file[&#34;GLOBALS&#34;]
        bars_worksheet = self.__workbook[self.__config_file[&#34;GLOBALS&#34;][&#34;available-bar-worksheet&#34;]]
        configuration_range = f&#34;{global_config[&#39;width-column&#39;]}{global_config[&#39;starting-row-bar&#39;]}:&#34; \
                              f&#34;{global_config[&#39;pieces-column&#39;]}{global_config[&#39;ending-row-bar&#39;]}&#34;

        global_bars_used = Counter()
        model_profile_bars = {}

        for model_name, profile_cuts in model_profile_cuts.items():
            profile_bars = {}
            for profile_code, cuts in profile_cuts.items():
                total_length = sum(cuts)
                bars = []
                for row in bars_worksheet[configuration_range]:
                    bar_length, available_bars = row[0].value, row[1].value
                    if bar_length is None or available_bars is None or available_bars == 0:
                        continue
                    while total_length &gt; 0 and available_bars &gt; global_bars_used[bar_length]:
                        pieces_used = min((total_length // bar_length) + 1, available_bars - global_bars_used[bar_length])
                        total_length -= pieces_used * bar_length
                        bars.append((bar_length, int(pieces_used)))
                        global_bars_used[bar_length] += pieces_used

                    if total_length &lt;= 0:
                        break

                if total_length &gt; 0:
                    default_bar_length = global_config[&#34;default-bar-length&#34;]
                    pieces_used = (total_length // default_bar_length) + 1
                    bars.append((default_bar_length, pieces_used))

                profile_bars[profile_code] = tuple(bars)

            model_profile_bars[model_name] = profile_bars

        return model_profile_bars

    def parse(self) -&gt; Tuple[Dict[str, Dict[str, Tuple[Tuple[int, int], ...]]], Order]:
        &#34;&#34;&#34;
        Executes the parse of the given excell file in input. This will extract the products from the configured
        input worksheet, build the workflow pipeline and executes it returning the order.

        Returns:
            The order to be translated in the p2k2 format.
        &#34;&#34;&#34;
        global_config = self.__config_file[&#34;GLOBALS&#34;]
        input_worksheet = self.__workbook[global_config[&#34;input-worksheet&#34;]]
        product_range = f&#34;{global_config[&#39;product-column&#39;]}{global_config[&#39;starting-row&#39;]}:&#34; \
                        f&#34;{global_config[&#39;product-column&#39;]}{global_config[&#39;ending-row&#39;]}&#34;

        values = [cell.value for row in input_worksheet[product_range] for cell in row if cell.value is not None]
        self.__define_workflows(values)
        self.__workflow_pipeline.execute()

        order = Order(buyer=self.__get_buyer_information())
        for model in self.__workflow_pipeline.get_branches_result():
            order.models.append(model)

        return self.__calculate_bars_for_order(order), order</code></pre>
</details>
<h3>Methods</h3>
<dl>
<dt id="p2k2_converter.core.Parser.parse"><code class="name flex">
<span>def <span class="ident">parse</span></span>(<span>self) ‑> Tuple[Dict[str, Dict[str, Tuple[Tuple[int, int], ...]]], <a title="p2k2_converter.core.classes.core_classes.Order" href="classes/core_classes.html#p2k2_converter.core.classes.core_classes.Order">Order</a>]</span>
</code></dt>
<dd>
<div class="desc"><p>Executes the parse of the given excell file in input. This will extract the products from the configured
input worksheet, build the workflow pipeline and executes it returning the order.</p>
<h2 id="returns">Returns</h2>
<p>The order to be translated in the p2k2 format.</p></div>
<details class="source">
<summary>
<span>Expand source code</span>
</summary>
<pre><code class="python">def parse(self) -&gt; Tuple[Dict[str, Dict[str, Tuple[Tuple[int, int], ...]]], Order]:
    &#34;&#34;&#34;
    Executes the parse of the given excell file in input. This will extract the products from the configured
    input worksheet, build the workflow pipeline and executes it returning the order.

    Returns:
        The order to be translated in the p2k2 format.
    &#34;&#34;&#34;
    global_config = self.__config_file[&#34;GLOBALS&#34;]
    input_worksheet = self.__workbook[global_config[&#34;input-worksheet&#34;]]
    product_range = f&#34;{global_config[&#39;product-column&#39;]}{global_config[&#39;starting-row&#39;]}:&#34; \
                    f&#34;{global_config[&#39;product-column&#39;]}{global_config[&#39;ending-row&#39;]}&#34;

    values = [cell.value for row in input_worksheet[product_range] for cell in row if cell.value is not None]
    self.__define_workflows(values)
    self.__workflow_pipeline.execute()

    order = Order(buyer=self.__get_buyer_information())
    for model in self.__workflow_pipeline.get_branches_result():
        order.models.append(model)

    return self.__calculate_bars_for_order(order), order</code></pre>
</details>
</dd>
</dl>
</dd>
</dl>
</section>
</article>
<nav id="sidebar">
<h1>Index</h1>
<div class="toc">
<ul></ul>
</div>
<ul id="index">
<li><h3>Super-module</h3>
<ul>
<li><code><a title="p2k2_converter" href="../index.html">p2k2_converter</a></code></li>
</ul>
</li>
<li><h3><a href="#header-submodules">Sub-modules</a></h3>
<ul>
<li><code><a title="p2k2_converter.core.classes" href="classes/index.html">p2k2_converter.core.classes</a></code></li>
<li><code><a title="p2k2_converter.core.parser" href="parser.html">p2k2_converter.core.parser</a></code></li>
<li><code><a title="p2k2_converter.core.utils" href="utils/index.html">p2k2_converter.core.utils</a></code></li>
<li><code><a title="p2k2_converter.core.workflow" href="workflow/index.html">p2k2_converter.core.workflow</a></code></li>
</ul>
</li>
<li><h3><a href="#header-classes">Classes</a></h3>
<ul>
<li>
<h4><code><a title="p2k2_converter.core.Parser" href="#p2k2_converter.core.Parser">Parser</a></code></h4>
<ul class="">
<li><code><a title="p2k2_converter.core.Parser.parse" href="#p2k2_converter.core.Parser.parse">parse</a></code></li>
</ul>
</li>
</ul>
</li>
</ul>
</nav>
</main>
<footer id="footer">
<p>Generated by <a href="https://pdoc3.github.io/pdoc" title="pdoc: Python API documentation generator"><cite>pdoc</cite> 0.10.0</a>.</p>
</footer>
</body>
</html>